<!-- Mermaid.js Support for Diagrams -->
<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize Mermaid with theme detection
    const isDark = document.body.className.includes('dark');
    mermaid.initialize({
      startOnLoad: false,
      theme: isDark ? 'dark' : 'default',
      // securityLevel: 'loose' required for proper rendering of sequence diagrams
      // Safe here: all content is static and author-controlled (no user-generated content)
      securityLevel: 'loose',
    });    // Find all code blocks that might contain mermaid diagrams
    document.querySelectorAll('pre code').forEach((block) => {
      const code = block.textContent.trim();
      // Check if it starts with mermaid diagram keywords
      if (code.match(/^(sequenceDiagram|graph|flowchart|classDiagram|stateDiagram|erDiagram|journey|gantt|pie|gitGraph)/)) {
        const pre = block.parentElement;
        const container = document.createElement('div');
        container.className = 'mermaid';
        container.textContent = code;
        pre.replaceWith(container);
      }
    });
    
    // Render all mermaid diagrams
    mermaid.run();
    
    // Handle theme toggle
    const themeToggle = document.getElementById('theme-toggle');
    if (themeToggle) {
      themeToggle.addEventListener('click', () => {
        setTimeout(() => {
          const isDark = document.body.className.includes('dark');
          mermaid.initialize({ 
            theme: isDark ? 'dark' : 'default',
            securityLevel: 'loose',
          });
          
          // Re-render all mermaid diagrams
          document.querySelectorAll('.mermaid').forEach((element) => {
            element.removeAttribute('data-processed');
          });
          mermaid.run();
        }, 100);
      });
    }
  });
</script>
